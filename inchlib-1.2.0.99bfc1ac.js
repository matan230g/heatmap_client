parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"k0lz":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initTable=t,exports.addMir=n;var e=new Set;function t(t){e=new Set,t.innerHTML=""}function n(t,n){if("inchlib1"===n||"inchlib"===n)var c=document.getElementById("table-connect-1to2"),i=document.getElementById("table-connect-1to2").rows.length,l="connect_1to2";else c=document.getElementById("table-connect-2to1"),i=document.getElementById("table-connect-2to1").rows.length,l="connect_2to1";t.forEach(function(t){if(!e.has(t)){e.add(t);var n=c.insertRow(i);n.insertCell(0).innerText=t;var r=t+"-getDetailes-"+l;n.insertCell(1).innerHTML="<button id=".concat(r,"  type='button' >Click here</button>"),n.insertCell(2).innerHTML="<i id=".concat(t,' style="color:red;"class="fas fa-trash-alt"></i>'),document.getElementById(t).addEventListener("click",function(n){var o=n.target.parentNode.parentNode;o.parentNode.removeChild(o),e.delete(t)}),document.getElementById(r).addEventListener("click",o),i++}})}function o(e){var t=e.target.parentNode.children[0].id.split("-"),n=t[0],o=t[2],i=document.getElementById("connection_list");c("connect_1to2"===o?"first_second_connections":"second_first_connections",n,i),$("#connection-dialog").modal("show")}function c(e,t,n){var o=localStorage.getItem(e),c=JSON.parse(o);null==c[t]||0==c[t].length?n.textContent="There are no suitable connections":n.textContent=c[t]}
},{}],"gZhb":[function(require,module,exports) {
var define;
var t;!function(){var e=Array.prototype.forEach,n=Object.prototype.hasOwnProperty,r=Array.prototype.slice,i=0;var s,o={keys:Object.keys||function(t){if("object"!=typeof t&&"function"!=typeof t||null===t)throw new TypeError("keys() called on a non-object");var e,n=[];for(e in t)t.hasOwnProperty(e)&&(n[n.length]=e);return n},uniqueId:function(t){var e=++i+"";return t?t+e:e},has:function(t,e){return n.call(t,e)},each:function(t,n,r){if(null!=t)if(e&&t.forEach===e)t.forEach(n,r);else if(t.length===+t.length)for(var i=0,s=t.length;i<s;i++)n.call(r,t[i],i,t);else for(var o in t)this.has(t,o)&&n.call(r,t[o],o,t)},once:function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}}};s={on:function(t,e,n){return l(this,"on",t,[e,n])&&e?(this._events||(this._events={}),(this._events[t]||(this._events[t]=[])).push({callback:e,context:n,ctx:n||this}),this):this},once:function(t,e,n){if(!l(this,"once",t,[e,n])||!e)return this;var r=this,i=o.once(function(){r.off(t,i),e.apply(this,arguments)});return i._callback=e,this.on(t,i,n)},off:function(t,e,n){var r,i,s,c,a,f,h,u;if(!this._events||!l(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events={},this;for(a=0,f=(c=t?[t]:o.keys(this._events)).length;a<f;a++)if(t=c[a],s=this._events[t]){if(this._events[t]=r=[],e||n)for(h=0,u=s.length;h<u;h++)i=s[h],(e&&e!==i.callback&&e!==i.callback._callback||n&&n!==i.context)&&r.push(i);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=r.call(arguments,1);if(!l(this,"trigger",t,e))return this;var n=this._events[t],i=this._events.all;return n&&a(n,e),i&&a(i,arguments),this},stopListening:function(t,e,n){var r=this._listeners;if(!r)return this;var i=!e&&!n;for(var s in"object"==typeof e&&(n=this),t&&((r={})[t._listenerId]=t),r)r[s].off(e,n,this),i&&delete this._listeners[s];return this}};var c=/\s+/,l=function(t,e,n,r){if(!n)return!0;if("object"==typeof n){for(var i in n)t[e].apply(t,[i,n[i]].concat(r));return!1}if(c.test(n)){for(var s=n.split(c),o=0,l=s.length;o<l;o++)t[e].apply(t,[s[o]].concat(r));return!1}return!0},a=function(t,e){var n,r=-1,i=t.length,s=e[0],o=e[1],c=e[2];switch(e.length){case 0:for(;++r<i;)(n=t[r]).callback.call(n.ctx);return;case 1:for(;++r<i;)(n=t[r]).callback.call(n.ctx,s);return;case 2:for(;++r<i;)(n=t[r]).callback.call(n.ctx,s,o);return;case 3:for(;++r<i;)(n=t[r]).callback.call(n.ctx,s,o,c);return;default:for(;++r<i;)(n=t[r]).callback.apply(n.ctx,e)}};o.each({listenTo:"on",listenToOnce:"once"},function(t,e){s[e]=function(e,n,r){return(this._listeners||(this._listeners={}))[e._listenerId||(e._listenerId=o.uniqueId("l"))]=e,"object"==typeof n&&(r=this),e[t](n,r,this),this}}),s.bind=s.on,s.unbind=s.off,s.mixin=function(t){return o.each(["on","once","off","trigger","stopListening","listenTo","listenToOnce","bind","unbind"],function(e){t[e]=this[e]},this),t},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=s),exports.BackboneEvents=s):"function"==typeof t&&"object"==typeof t.amd?t(function(){return s}):this.BackboneEvents=s}();
},{}],"PgLR":[function(require,module,exports) {
module.exports=require("./backbone-events-standalone");
},{"./backbone-events-standalone":"gZhb"}],"iPX1":[function(require,module,exports) {
var n=require("backbone-events-standalone");n.onAll=function(n,i){return this.on("all",n,i),this},n.oldMixin=n.mixin,n.mixin=function(i){n.oldMixin(i);for(var o=["onAll"],e=0;e<o.length;e++){var l=o[e];i[l]=this[l]}return i},module.exports=n;
},{"backbone-events-standalone":"PgLR"}],"dVJU":[function(require,module,exports) {
function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}var e,a,o=require("../components/insertable"),n=o.addMir;function s(e){return e&&"object"==t(e)&&"[object RegExp]"!==Object.prototype.toString.call(e)&&"[object Date]"!==Object.prototype.toString.call(e)}function r(t){return Array.isArray(t)?[]:{}}function _(t,e){return e&&!0===e.clone&&s(t)?h(r(t),t,e):t}function l(t,e,i){var a=t.slice();return e.forEach(function(e,o){void 0===a[o]?a[o]=_(e,i):s(e)?a[o]=h(t[o],e,i):-1===t.indexOf(e)&&a.push(_(e,i))}),a}function d(t,e,i){var a={};return s(t)&&Object.keys(t).forEach(function(e){a[e]=_(t[e],i)}),Object.keys(e).forEach(function(o){s(e[o])&&t[o]?a[o]=h(t[o],e[o],i):a[o]=_(e[o],i)}),a}function h(t,e,i){var a=Array.isArray(e),o=(i||{arrayMerge:l}).arrayMerge||l;return a?Array.isArray(t)?o(t,e,i):_(e,i):d(t,e,i)}h.all=function(t,e){if(!Array.isArray(t)||t.length<2)throw new Error("first argument should be an array with at least two elements");return t.reduce(function(t,i){return h(t,i,e)})},(e=function(t){(a=this).user_settings=t,a.target_element=$("#"+t.target),a.target_element.css({position:"relative"}),a.settings={target:"YourOwnDivId",heatmap_header:{draw:!0,settings:{fontFamily:"sans-serif",fontSize:10,rotation:-80,fill:"#000000"}},heatmap:{draw:!0,colors:{scale:"Greens",value_type:"percentile",independent_columns:!0,params:{min:0,middle:50,max:100}},columns_order:[],row_height:{min:1,max:25},column_width:{max:150},relative_width:.7,font:{fontFamily:"Helvetica",fill:"#000000"}},dendrogram:{draw:!0,unified_distance:!1},metadata:{draw:!1,colors:{independent_columns:!0,value_type:"percentile",scale:"Reds",params:{min:0,middle:50,max:100},value2color:{},default:"#F5F5F5"}},column_metadata:{draw:!0,row_height:8,feature_names:{draw:!0,settings:{fontFamily:"Helvetica",fontSize:void 0,fill:"#000000"}},colors:{independent_columns:!0,value_type:"percentile",scale:"Reds",params:{min:0,middle:50,max:100},value2color:{},default:"#F5F5F5"}},row_ids:{draw:!1,fixed_size:!1,tooltip:!0},column_dendrogram:{draw:!0},count_column:{draw:!1,colors:"Reds"},max_height:1200,width:1600,highlight_colors:"Oranges",highlighted_rows:[],label_color:"#9E9E9E",alternative_data:!1,images:{draw:!1,path:{dir:"",ext:""}},navigation_toggle:{color_scale:!0,distance_scale:!0,export_button:!0,filter_button:!0,hint_button:!0}},a.update_settings(t),a.settings.width=t.max_width&&t.max_width<target_width?t.max_width:a.settings.width,a.settings.heatmap.relative_width=a.settings.heatmap.relative_width>.9?.9:a.settings.heatmap.relative_width,a.header_height=150,a.footer_height=70,a.dendrogram_heatmap_distance=5,a.events={row_click:function(t,e){},row_onclick:function(e,i){return console.log("hererrere"),n(e,t.target),a.events.row_click(e,i),e},row_mouseover:function(t,e){},row_onmouseover:function(t,e){a.events.row_mouseover(t,e)},row_mouseout:function(t){},row_onmouseout:function(t){a.events.row_mouseout(t)},dendrogram_node_click:function(t,e,i){},dendrogram_node_onclick:function(t,e,i){a.events.dendrogram_node_click(t,e,i)},column_dendrogram_node_click:function(t,e,i){},column_dendrogram_node_onclick:function(t,e,i){a.events.column_dendrogram_node_click(t,e,i)},dendrogram_node_highlight:function(t,e){},column_dendrogram_node_highlight:function(t,e){},dendrogram_node_unhighlight:function(t){},column_dendrogram_node_unhighlight:function(t){},heatmap_onmouseout:function(t){},on_zoom:function(t,e){},on_unzoom:function(t){},on_columns_zoom:function(t,e){},on_columns_unzoom:function(t){},on_refresh:function(){},empty_space_click:function(t){},empty_space_onclick:function(t){a.events.empty_space_click(t)},cell_click:function(t,e){},cell_mouseover:function(t,e){}},a.colors={YlGn:{start:{r:255,g:255,b:204},end:{r:35,g:132,b:67}},GnBu:{start:{r:240,g:249,b:232},end:{r:43,g:140,b:190}},BuGn:{start:{r:237,g:248,b:251},end:{r:35,g:139,b:69}},PuBu:{start:{r:241,g:238,b:246},end:{r:5,g:112,b:176}},BuPu:{start:{r:237,g:248,b:251},end:{r:136,g:65,b:157}},RdPu:{start:{r:254,g:235,b:226},end:{r:174,g:1,b:126}},PuRd:{start:{r:241,g:238,b:246},end:{r:206,g:18,b:86}},OrRd:{start:{r:254,g:240,b:217},end:{r:215,g:48,b:31}},Purples2:{start:{r:242,g:240,b:247},end:{r:106,g:81,b:163}},Blues:{start:{r:239,g:243,b:255},end:{r:33,g:113,b:181}},Greens:{start:{r:237,g:248,b:233},end:{r:35,g:139,b:69}},Oranges:{start:{r:254,g:237,b:222},end:{r:217,g:71,b:1}},Reds:{start:{r:254,g:229,b:217},end:{r:203,g:24,b:29}},Greys:{start:{r:247,g:247,b:247},end:{r:82,g:82,b:82}},PuOr:{start:{r:230,g:97,b:1},end:{r:94,g:60,b:153}},BrBG:{start:{r:166,g:97,b:26},end:{r:1,g:133,b:113}},RdBu:{start:{r:202,g:0,b:32},end:{r:5,g:113,b:176}},RdGy:{start:{r:202,g:0,b:32},end:{r:64,g:64,b:64}},BuYl:{start:{r:5,g:113,b:176},end:{r:250,g:233,b:42}},YlOrR:{start:{r:255,g:255,b:178},end:{r:227,g:26,b:28},middle:{r:204,g:76,b:2}},YlOrB:{start:{r:255,g:255,b:212},end:{r:5,g:112,b:176},middle:{r:204,g:76,b:2}},PRGn2:{start:{r:123,g:50,b:148},end:{r:0,g:136,b:55},middle:{r:202,g:0,b:32}},PiYG2:{start:{r:208,g:28,b:139},end:{r:77,g:172,b:38},middle:{r:255,g:255,b:178}},YlGnBu:{start:{r:255,g:255,b:204},end:{r:34,g:94,b:168},middle:{r:35,g:132,b:67}},RdYlBu:{start:{r:215,g:25,b:28},end:{r:44,g:123,b:182},middle:{r:255,g:255,b:178}},RdYlGn:{start:{r:215,g:25,b:28},end:{r:26,g:150,b:65},middle:{r:255,g:255,b:178}},BuWhRd:{start:{r:33,g:113,b:181},middle:{r:255,g:255,b:255},end:{r:215,g:25,b:28}},RdLrBu:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:44,g:123,b:182}},RdBkGr:{start:{r:215,g:25,b:28},middle:{r:0,g:0,b:0},end:{r:35,g:139,b:69}},RdLrGr:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:35,g:139,b:69}}},a.objects_ref={tooltip_label:new Konva.Label({opacity:1,listening:!1,preventDefault:!1}),tooltip_tag:new Konva.Tag({fill:a.settings.label_color,pointerWidth:10,pointerHeight:10,lineJoin:"round",listening:!1,preventDefault:!1}),tooltip_text:new Konva.Text({fontFamily:a.settings.heatmap.font.fontFamily,fontSize:12,padding:8,fill:"white",fontStyle:"bold",listening:!1,align:"center",lineHeight:1.2,preventDefault:!1}),node:new Konva.Line({stroke:"grey",strokeWidth:2,lineCap:"sqare",lineJoin:"round",listening:!1,preventDefault:!1}),node_rect:new Konva.Rect({fill:"white",opacity:0,preventDefault:!1}),icon_overlay:new Konva.Rect({width:32,height:32,opacity:0,preventDefault:!1}),heatmap_value:new Konva.Text({fontFamily:a.settings.heatmap.font.fontFamily,fill:a.settings.heatmap.font.fill,fontStyle:"bold",listening:!1,preventDefault:!1}),heatmap_line:new Konva.Line({lineCap:"butt",value:!1,preventDefault:!1}),column_header:new Konva.Text({fontFamily:a.settings.heatmap.font.fontFamily,fontStyle:"bold",fill:"black",preventDefault:!1}),count:new Konva.Text({fontSize:10,fill:"#6d6b6a",fontFamily:a.settings.heatmap.font.fontFamily,fontStyle:"bold",listening:!1,preventDefault:!1}),cluster_overlay:new Konva.Rect({fill:"white",opacity:.5,preventDefault:!1}),cluster_border:new Konva.Line({stroke:"black",strokeWidth:1,dash:[6,2],preventDefault:!1}),icon:new Konva.Path({fill:"grey",preventDefault:!1}),rect_gradient:new Konva.Rect({x:0,y:80,width:80,height:20,fillLinearGradientStartPoint:{x:0,y:80},fillLinearGradientEndPoint:{x:100,y:80},stroke:"#D2D2D2",strokeWidth:"1px",preventDefault:!1}),image:new Konva.Image({stroke:"#D2D2D2",strokeWidth:1,preventDefault:!1})},a.paths_ref={zoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",unzoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",lightbulb:"M15.5,2.833c-3.866,0-7,3.134-7,7c0,3.859,3.945,4.937,4.223,9.499h5.553c0.278-4.562,4.224-5.639,4.224-9.499C22.5,5.968,19.366,2.833,15.5,2.833zM15.5,28.166c1.894,0,2.483-1.027,2.667-1.666h-5.334C13.017,27.139,13.606,28.166,15.5,28.166zM12.75,25.498h5.5v-5.164h-5.5V25.498z"}}).prototype._update_user_settings=function(t){this.update_settings(t)},e.prototype.read_data=function(t){var e=this;e.json=t,e.data=e.json.data,console.log("asdsadasdadad"),console.log(t.data);var i={metadata:{},column_dendrogram:{},column_metadata:{}};void 0!==t.metadata&&e.settings.metadata.draw?(e.metadata=t.metadata,i.metadata.draw=!0):i.metadata.draw=!1,void 0!==t.column_dendrogram&&e.settings.column_dendrogram.draw?(e.column_dendrogram=t.column_dendrogram,i.column_dendrogram.draw=!0,i.heatmap_header={settings:{rotation:-1*e.settings.heatmap_header.settings.rotation}}):i.column_dendrogram.draw=!1,console.log('json["column_metadata"]'+e.settings.column_metadata),console.log("json.column_metadata"+JSON.stringify(t.column_metadata)),void 0!==t.column_metadata&&e.settings.column_metadata.draw?(e.column_metadata=t.column_metadata,i.column_metadata.draw=!0):i.column_metadata.draw=!1,void 0!==e.json.alternative_data&&e.settings.alternative_data?e.alternative_data=e.json.alternative_data.nodes:i.alternative_data=!1,void 0!==e.data.feature_names&&e.data.feature_names.length>0||void 0!==e.metadata&&void 0!==e.metadata.feature_names&&e.metadata.feature_names.length>0?e.settings.heatmap_header.draw=!0:e.settings.heatmap_header.draw=!1,e._update_user_settings(i),e._add_prefix(),e.node_ids=Object.keys(e.data.nodes),e.leaf_ids=e.node_ids.filter(function(t){return 1===e.data.nodes[t].count})},e.prototype.send_json=function(t){this.read_data(t)},e.prototype._add_prefix=function(){if(this.data.nodes=this._add_prefix_to_data(this.data.nodes),this.settings.metadata.draw){for(var t={},e=0,i=(a=Object.keys(this.metadata.nodes)).length;e<i;e++)id=[this.settings.target,a[e]].join("#"),t[id]=this.metadata.nodes[a[e]];this.metadata.nodes=t}if(this.settings.alternative_data){var a,o={};for(e=0,i=(a=Object.keys(this.alternative_data)).length;e<i;e++)id=[this.settings.target,a[e]].join("#"),o[id]=this.alternative_data[a[e]];this.alternative_data=o}this.column_dendrogram&&(this.column_dendrogram.nodes=this._add_prefix_to_data(this.column_dendrogram.nodes))},e.prototype._add_prefix_to_data=function(t){for(var e,i={},a=0,o=Object.keys(t),n=o.length;a<n;a++)i[e=[this.settings.target,o[a]].join("#")]=t[o[a]],void 0!==i[e].parent&&(i[e].parent=[this.settings.target,i[e].parent].join("#")),1!=i[e].count&&(i[e].left_child=[this.settings.target,i[e].left_child].join("#"),i[e].right_child=[this.settings.target,i[e].right_child].join("#"));return i},e.prototype._get_root_id=function(t){for(var e,i=0,a=Object.keys(t),o=a.length;i<o;i++)if(void 0===t[a[i]].parent){e=a[i];break}return e},e.prototype._get_dimensions=function(){var t={data:0,metadata:0,overall:0};return this.settings.images.draw?t.data=this.alternative_data[this.leaf_ids[0]].length:t.data=this.data.nodes[this.leaf_ids[0]].features.length,this.settings.metadata.draw&&(t.metadata=this.metadata.nodes[this.leaf_ids[0]].length),t.overall=t.data+t.metadata,t},e.prototype._get_min_max_middle=function(t){for(var e=[],i=0,a=t.length;i<a;i++)e=e.concat(t[i].filter(function(t){return null!==t}));a=e.length;return e.sort(function(t,e){return t-e}),[this.settings.heatmap.colors.params.min>0?e[this._hack_round(a*this.settings.heatmap.colors.params.min/100)]:Math.min.apply(null,e),this.settings.heatmap.colors.params.max<100?e[this._hack_round(a*this.settings.heatmap.colors.params.max/100)]:Math.max.apply(null,e),50!=this.settings.heatmap.colors.params.middle?e[this._hack_round(a*this.settings.heatmap.colors.params.middle/100)]:e[this._hack_round((a-1)/2)]]},e.prototype._get_data_min_max_middle=function(t,e,i){if(void 0===e&&(e="column"),void 0===i)i="heatmap";var a,o,n,s,r,_={},l=t[0].length;if("column"==e){for(r=[],a=0;a<l;a++)r.push([]);for(a=0;a<t.length;a++)for(o=0;o<l;o++)null!=(n=t[a][o])&&r[o].push(n)}else r=t.slice(0);var d,h,c;if("value"===this.settings[i].value_type)for(a=0;a<r.length;a++)_[a]=$.extend({},this.settings[i].colors.params);else for(a=0;a<r.length;a++)if(this._is_number(r[a][0]))r[a]=r[a].map(parseFloat),r[a].sort(function(t,e){return t-e}),s=r[a].length,h=this.settings[i].colors.params.max<100?r[a][this._hack_round(s*this.settings[i].colors.params.max/100)-1]:Math.max.apply(null,r[a]),d=this.settings[i].colors.params.min>0?r[a][this._hack_round(s*this.settings[i].colors.params.min/100)]:Math.min.apply(null,r[a]),c=50!=this.settings[i].colors.params.middle?r[a][this._hack_round(s*this.settings[i].colors.params.middle/100)]:r[a][this._hack_round((s-1)/2)],_[a]={min:d,max:h,middle:c};else{var u=this._get_hash_object(r[a]);d=0,c=(h=this._hack_size(u)-1)/2,_[a]={min:d,max:h,middle:c,str2num:u}}return _},e.prototype._get_hash_object=function(t){var e,i=0,a={};for(e=0;e<t.length;e++)void 0===a[t[e]]&&(a[t[e]]=i,i++);return a},e.prototype._get_max_length=function(t){var e=t.map(function(t){return(""+t).length});return Math.max.apply(Math,e)},e.prototype._get_max_value_length=function(){var t,e=this,i=0;if(e.settings.images.draw)i=0;else{if(e.settings.alternative_data)var a=e.current_leaf_ids.map(function(t){return e.alternative_data[t]});else a=e.current_leaf_ids.map(function(t){return e.data.nodes[t].features});e.settings.metadata.draw&&(a=a.concat(e.current_leaf_ids.map(function(t){return e.metadata.nodes[t]})));for(var o=0,n=a.length;o<n;o++)for(var s=0,r=(t=a[o]).length;s<r;s++)(""+t[s]).length>i&&(i=(""+t[s]).length)}return i},e.prototype._preprocess_heatmap_data=function(){var t,e,i,a,o,n=[],s=0;for(t=0,i=this.node_ids.length;t<i;t++)e=this.node_ids[t],1==(o=this.data.nodes[e]).count&&(a=o.features,n.push([e]),n[s].push.apply(n[s],a),this.settings.metadata.draw&&n[s].push.apply(n[s],this.metadata.nodes[e]),s++);return n},e.prototype._reorder_heatmap=function(t){this.leaves_y_coordinates={},t++,this.ordered_by_index==t?this.heatmap_array.reverse():this._is_number(this.heatmap_array[0][t])?this.heatmap_array.sort(function(e,i){return null==e[t]?-1:null==i[t]?1:e[t]-i[t]}):this.heatmap_array.sort(function(e,i){return null==e[t]?-1:null==i[t]?1:e[t]>i[t]?1:e[t]<i[t]?-1:0});for(var e=this.top_heatmap_distance,i=0,a=this.heatmap_array.length;i<a;i++)this.leaves_y_coordinates[this.heatmap_array[i][0]]=e,e+=this.pixels_for_leaf;this.ordered_by_index=t},e.prototype.draw=function(){console.time("DRAW");this.zoomed_clusters={row:[],column:[]},this.last_highlighted_cluster=null,this.current_object_ids=[],this.current_column_ids=[],this.highlighted_rows_y=[],this.heatmap_array=this._preprocess_heatmap_data(),this.on_features={data:[],metadata:[],count_column:[]},this.column_metadata_rows=this.settings.column_metadata.draw?this.column_metadata.features.length:0,this.column_metadata_height=this.column_metadata_rows*this.settings.column_metadata.row_height,this.settings.heatmap.draw?(this.last_column=null,this.dimensions=this._get_dimensions(),this._set_heatmap_settings()):(this.dimensions={data:0,metadata:0,overall:0},this.settings.heatmap_header.draw=!1,this.settings.column_dendrogram.draw=!1),this._adjust_leaf_size(this.heatmap_array.length),this.settings.row_ids.draw?this._get_row_id_size():this.right_margin=100,this._adjust_horizontal_sizes(),this.top_heatmap_distance=this.header_height+this.column_metadata_height+this.settings.column_metadata.row_height/2,this.settings.column_dendrogram.draw&&this.heatmap_header&&(this.footer_height=150),this.stage=new Konva.Stage({container:this.settings.target}),this.settings.height=this.heatmap_array.length*this.pixels_for_leaf+this.header_height+this.footer_height,this.stage.setWidth(this.settings.width),this.stage.setHeight(this.settings.height),this._draw_stage_layer(),(this.settings.dendrogram.draw||this.settings.column_dendrogram.draw)&&(this.timer=0,this._draw_dendrogram_layers()),this.settings.dendrogram.draw?(console.time("DENDROGRAM"),this.root_id=this._get_root_id(this.data.nodes),this._draw_row_dendrogram(this.root_id),console.timeEnd("DENDROGRAM")):(this._reorder_heatmap(0),this.ordered_by_index=0),this.settings.column_dendrogram.draw&&(this.column_root_id=this._get_root_id(this.column_dendrogram.nodes),this.nodes2columns=!1,this.columns_start_index=0,this._draw_column_dendrogram(this.column_root_id)),this.settings.images.draw&&(this.path2image={},this.path2image_obj={},this.image_counter=0),this._draw_heatmap(),this._draw_heatmap_header(),this._draw_navigation(),this.highlight_rows(this.settings.highlighted_rows),console.timeEnd("DRAW"),document.getElementById("spinner").style.display="none",$("html, body").animate({scrollTop:0},"fast")},e.prototype._draw_dendrogram_layers=function(){var t=this;t.cluster_layer=new Konva.Layer,t.dendrogram_hover_layer=new Konva.Layer,t.stage.add(t.cluster_layer,t.dendrogram_hover_layer),t.cluster_layer.on("click",function(e){t.unhighlight_cluster(),t.unhighlight_column_cluster(),t.events.empty_space_onclick(e)})},e.prototype._get_node_levels=function(t){for(var e=0,i=Object.keys(t),a=i.length;e<a;e++){var o=i[e],n=1;if(1==t[o].count){t[o].level=n,n++;for(var s=t[o];"parent"in s;){var r=s.parent;(null==t[r].level||t[r].level<n)&&(t[r].level=n),n++,s=t[r]}}}},e.prototype._draw_row_dendrogram=function(t){var e=this;e.dendrogram_layer=new Konva.Layer;var i=e.data.nodes[t],a=i.count;e.distance_step=e.distance/i.distance,e.leaves_y_coordinates={},e.objects2leaves={},e._adjust_leaf_size(a),e.settings.height=a*e.pixels_for_leaf+e.header_height+e.footer_height+e.column_metadata_height,e.stage.setWidth(e.settings.width),e.stage.setHeight(e.settings.height);var o=0,n=0,s=e.header_height+e.column_metadata_height+e.pixels_for_leaf/2;i.count>1&&(o=e.data.nodes[i.left_child].count,n=e.data.nodes[i.right_child].count),e.settings.dendrogram.unified_distance&&(e._get_node_levels(e.data.nodes),e.unified_distance_step=e.data.nodes[t].distance/e.data.nodes[t].level);for(var r=[[i,{node_id:t,current_left_count:o,current_right_count:n,x:0,y:s}]];r.length>0;){for(var _=[],l=0,d=r.length;l<d;l++)_=_.concat(e._draw_row_dendrogram_node(r[l][0],r[l][1]));r=_.map(function(t,e){return t})}e.middle_item_count=(e.min_item_count+e.max_item_count)/2,e._draw_distance_scale(i.distance),e.stage.add(e.dendrogram_layer),e.current_leaf_ids=Object.keys(e.leaves_y_coordinates),e._bind_dendrogram_hover_events(e.dendrogram_layer),e.dendrogram_layer.on("click",function(t){e._dendrogram_layers_click(this,t)}),e.dendrogram_layer.on("mousedown",function(t){e._dendrogram_layers_mousedown(this,t)}),e.dendrogram_layer.on("mouseup",function(t){e._dendrogram_layers_mouseup(this,t)})},e.prototype._draw_row_dendrogram_node=function(t,e){var i=[];if(void 0!==t.color?e.color=t.color:void 0!==e.color&&(t.color=e.color),t.count>1){var a=this._get_node_neighbourhood(t,this.data.nodes),o=this.data.nodes[t.right_child],n=this.data.nodes[t.left_child],s=this._get_y1(a,e.current_left_count,e.current_right_count),r=this._get_y2(a,e.current_left_count,e.current_right_count),_=this.distance,l=this.distance;if(this.settings.dendrogram.unified_distance){var d=this._hack_round(this.distance-t.level*this.distance_step*this.unified_distance_step);this.data.nodes[t.left_child].count>1&&(_=this.distance-this.data.nodes[t.left_child].level*this.distance_step*this.unified_distance_step),this.data.nodes[t.right_child].count>1&&(l=this.distance-this.data.nodes[t.right_child].level*this.distance_step*this.unified_distance_step)}else{d=this._hack_round(this.distance-this.distance_step*t.distance);_=this.distance-this.distance_step*this.data.nodes[t.left_child].distance,l=this.distance-this.distance_step*this.data.nodes[t.right_child].distance}var h=d=0==d?2:d;1==o.count&&(r+=this.pixels_for_leaf/2),this.dendrogram_layer.add(this._draw_horizontal_path(e.node_id,d,s,h,r,_,l,e.color)),i.push([n,{node_id:t.left_child,current_left_count:e.current_left_count-a.left_node.right_count,current_right_count:e.current_right_count+a.left_node.right_count,x:_,y:s,color:e.color}]),i.push([o,{node_id:t.right_child,current_left_count:e.current_left_count+a.right_node.left_count,current_right_count:e.current_right_count-a.right_node.left_count,x:l,y:r,color:e.color}])}else{var c=t.objects;this.leaves_y_coordinates[e.node_id]=e.y;for(var u=0,m=c.length;u<m;u++)this.objects2leaves[c[u]]=e.node_id;var g=t.objects.length;g<this.min_item_count&&(this.min_item_count=g),g>this.max_item_count&&(this.max_item_count=g)}return i},e.prototype._draw_stage_layer=function(){var t=this;t.stage_layer=new Konva.Layer;var e=new Konva.Rect({x:0,y:0,width:t.settings.width,height:t.settings.height,opacity:0,preventDefault:!1});t.stage_layer.add(e),e.moveToBottom(),t.stage.add(t.stage_layer),t.stage_layer.on("click",function(e){t.unhighlight_cluster(),t.unhighlight_column_cluster(),t.events.empty_space_onclick(e)})},e.prototype._draw_column_dendrogram=function(t){var e=this;e.column_dendrogram_layer=new Konva.Layer,e.column_x_coordinates={};var i=e.column_dendrogram.nodes[t];e.current_column_count=i.count,e.vertical_distance=e.header_height,e.vertical_distance_step=e.vertical_distance/i.distance,e.last_highlighted_column_cluster=null;var a=e.column_dendrogram.nodes[i.left_child].count,o=e.column_dendrogram.nodes[i.right_child].count;e._draw_column_dendrogram_node(t,i,a,o,0,0),e.stage.add(e.column_dendrogram_layer),e.nodes2columns||(e.nodes2columns=e._get_nodes2columns()),e._bind_dendrogram_hover_events(e.column_dendrogram_layer),e.column_dendrogram_layer.on("click",function(t){e._column_dendrogram_layers_click(this,t)}),e.column_dendrogram_layer.on("mousedown",function(t){e._column_dendrogram_layers_mousedown(this,t)}),e.column_dendrogram_layer.on("mouseup",function(t){e._dendrogram_layers_mouseup(this,t)})},e.prototype._get_nodes2columns=function(){var t,e,i,a=[],o={},n={};for(i=0,keys=Object.keys(this.column_x_coordinates),len=keys.length;i<len;i++)t=keys[i],o[e=this.column_x_coordinates[t]]=t,a.push(e);for(a.sort(function(t,e){return t-e}),i=0,len=a.length;i<len;i++)n[o[a[i]]]=i;return n},e.prototype._bind_dendrogram_hover_events=function(t){var e=this;t.on("mouseover",function(t){e._dendrogram_layers_mouseover(this,t)}),t.on("mouseout",function(t){e._dendrogram_layers_mouseout(this,t)})},e.prototype._delete_layers=function(t,e){for(var i=0,a=t.length;i<a;i++)void 0!==t[i]&&t[i].destroy();if(void 0!==e)for(i=0,a=e.length;i<a;i++)e[i].removeChildren(),e[i].draw()},e.prototype._delete_all_layers=function(){this.stage.destroyChildren()},e.prototype._adjust_leaf_size=function(t){this.pixels_for_leaf=(this.settings.max_height-this.header_height-this.footer_height-this.column_metadata_height-5)/t,this.settings.row_ids.draw&&this.settings.row_ids.fixed_size&&(this.settings.heatmap.row_height.min=this.settings.row_ids.fixed_size+2),this.pixels_for_leaf>this.settings.heatmap.row_height.max&&(this.pixels_for_leaf=this.settings.heatmap.row_height.max),this.settings.heatmap.row_height.min>this.pixels_for_leaf&&(this.pixels_for_leaf=this.settings.heatmap.row_height.min)},e.prototype._adjust_horizontal_sizes=function(t){void 0===this.right_margin&&(this.right_margin=100),void 0===t&&(t=this._get_visible_count()),this.settings.dendrogram.draw?(this.settings.heatmap.draw?this.heatmap_width=(this.settings.width-this.right_margin-this.dendrogram_heatmap_distance)*this.settings.heatmap.relative_width:this.heatmap_width=0,this.pixels_for_dimension=t>0&&this.heatmap_width>0?this.heatmap_width/t:0,0===this.pixels_for_dimension&&(this.heatmap_width=0),this.distance=this.settings.width-this.heatmap_width-this.right_margin,this.heatmap_distance=this.distance+this.dendrogram_heatmap_distance):(this.heatmap_width=this.settings.width-2*this.right_margin,this.distance=this.right_margin,this.heatmap_distance=this.distance,this.pixels_for_dimension=t?this.heatmap_width/t:0),this.settings.heatmap.column_width.max&&this.settings.heatmap.column_width.max<this.pixels_for_dimension&&(this.pixels_for_dimension=this.settings.heatmap.column_width.max,this.heatmap_width=t*this.pixels_for_dimension,this.settings.dendrogram.draw?(this.distance=this.settings.width-this.heatmap_width-this.right_margin-this.dendrogram_heatmap_distance,this.heatmap_distance=this.distance+this.dendrogram_heatmap_distance):(this.distance=this._hack_round((this.settings.width-this.heatmap_width)/2),this.right_margin=this.distance,this.heatmap_distance=this.distance))},e.prototype._set_color_settings=function(){var t=[];for(i=0,len=this.leaf_ids.length;i<len;i++)t.push(this.data.nodes[this.leaf_ids[i]].features);if(this.data_descs={},this.settings.heatmap.colors.independent_columns)this.data_descs=this._get_data_min_max_middle(t,"column","heatmap");else{var e=this._get_min_max_middle(t);for(i=0;i<this.dimensions.data;i++)this.data_descs[i]={min:e[0],max:e[1],middle:e[2]}}if(this.settings.metadata.draw){var a=[];for(i=0,len=this.leaf_ids.length;i<len;i++)a.push(this.metadata.nodes[this.leaf_ids[i]]);this.metadata_descs=this._get_data_min_max_middle(a,"column","metadata")}},e.prototype._set_heatmap_settings=function(){var t;for(this.header=[],t=0;t<this.dimensions.overall;t++)this.header.push("");if(0===this.settings.heatmap.columns_order.length||this.settings.heatmap.columns_order.length!==this.dimensions.data)for(this.settings.heatmap.columns_order=[],t=0;t<this.dimensions.data;t++)this.settings.heatmap.columns_order.push(t);if(this.settings.metadata.draw)for(t=this.dimensions.data;t<this.dimensions.data+this.dimensions.metadata;t++)this.settings.heatmap.columns_order.push(t);for(this.settings.count_column.draw&&this.settings.heatmap.columns_order.push(this.settings.heatmap.columns_order.length),this.features={},t=0;t<this.settings.heatmap.columns_order.length;t++)this.features[t]=!0;if(this._set_on_features(),this.heatmap_header=!1,this.metadata_header=!1,this.current_label=null,this._set_color_settings(),this.settings.alternative_data&&void 0!==this.json.alternative_data.feature_names?this.heatmap_header=this.json.alternative_data.feature_names:void 0!==this.data.feature_names&&(this.heatmap_header=this.data.feature_names),this.heatmap_header)for(t=0;t<this.dimensions.data;t++)this.header[t]=this.heatmap_header[this.on_features.data[t]].trim(" ");if(this.settings.metadata.draw&&this.metadata.feature_names)for(this.metadata_header=this.metadata.feature_names,t=0;t<this.dimensions.metadata;t++)this.header[this.dimensions.data+t]=this.metadata_header[t].trim(" ");this.settings.column_metadata.draw&&void 0!==this.column_metadata.feature_names&&(this.column_metadata_header=this.column_metadata.feature_names),this.settings.count_column.draw&&(this.max_item_count=1,this.min_item_count=1,this.dimensions.overall++,this.header.push("Count")),this._adjust_horizontal_sizes(),this.top_heatmap_distance=this.header_height+this.column_metadata_height+this.settings.column_metadata.row_height/2},e.prototype._set_on_features=function(t){var e;if(void 0===t){t=[];for(var i=0,a=Object.keys(this.features),o=a.length;i<o;i++)e=a[i],this.features[e]&&t.push(this.settings.heatmap.columns_order[i])}this.on_features={data:[],metadata:[],count_column:[]};for(i=0,o=t.length;i<o;i++)(e=t[i])<this.dimensions.data?this.on_features.data.push(e):e<=this.dimensions.data+this.dimensions.metadata-1?this.on_features.metadata.push(e-this.dimensions.data):this.on_features.count_column.push(0)},e.prototype._draw_heatmap=function(){var t=this;if(console.time("HEATMAP"),t.settings.heatmap.draw){var e,i;t.heatmap_layer=new Konva.Layer,t.heatmap_overlay=new Konva.Layer,t.current_draw_values=!0,t.max_value_length=t._get_max_value_length(),t.value_font_size=t._get_font_size(t.max_value_length,t.pixels_for_dimension,t.pixels_for_leaf,12),t.value_font_size<4&&(t.current_draw_values=!1);for(var a=t.heatmap_distance,o=0,n=t.current_leaf_ids.length;o<n;o++)key=t.current_leaf_ids[o],i=t.leaves_y_coordinates[key],e=t._draw_heatmap_row(key,a,i),t.heatmap_layer.add(e),t._bind_row_events(e);if(t.settings.column_metadata.draw){t.column_metadata_descs=t._get_data_min_max_middle(t.column_metadata.features,"row"),y1=t.header_height+.5*t.settings.column_metadata.row_height;for(o=0,n=t.column_metadata.features.length;o<n;o++)e=t._draw_column_metadata_row(t.column_metadata.features[o],o,a,y1),t.heatmap_layer.add(e),t._bind_row_events(e),y1+=t.settings.column_metadata.row_height}t.settings.row_ids.draw&&t._draw_row_ids(),t.highlighted_rows_layer=new Konva.Layer,t.stage.add(t.heatmap_layer,t.heatmap_overlay,t.highlighted_rows_layer),t.highlighted_rows_layer.moveToTop(),t.row_overlay=t.objects_ref.heatmap_line.clone(),t.column_overlay=t.objects_ref.heatmap_line.clone(),t.heatmap_layer.on("mouseout",function(e){t.last_header=null,t.heatmap_overlay.destroyChildren(),t.heatmap_overlay.draw(),t.events.heatmap_onmouseout(e)}),console.timeEnd("HEATMAP")}},e.prototype._draw_heatmap_row=function(t,e,i){for(var a,o,n,s,r,_,l,d,h=this,c=h.data.nodes[t],u=new Konva.Group({id:t}),m=0,g=h.on_features.data.length;m<g;m++){if(d=h.on_features.data[m],a=e+h.pixels_for_dimension,o=i,l=r=c.features[d],h.settings.alternative_data&&(l=h.alternative_data[t][d]),h.settings.images.draw&&![void 0,null,""].includes(l)){r=null;var p=h.settings.images.path.dir+l+h.settings.images.path.ext;if(p=escape(p),void 0===h.path2image[l]){var f=new Image;f.src=p,f.onload=function(){h.image_counter++,h.image_counter===Object.keys(h.path2image).length&&h.heatmap_layer.draw()},h.path2image_obj[l]=f,h.path2image[l]=h.objects_ref.image.clone({image:h.path2image_obj[l]})}var v=h.path2image[l].clone({width:h.pixels_for_dimension,height:h.pixels_for_leaf,x:e,y:i-h._hack_round(.5*h.pixels_for_leaf),points:[e,i,e+h.pixels_for_dimension,null],column:["d",d].join("_"),value:l});u.add(v)}else null!==r&&(n=h._get_color_for_value(r,h.data_descs[d].min,h.data_descs[d].max,h.data_descs[d].middle,h.settings.heatmap.colors.scale),l=l.toString(),s=h.objects_ref.heatmap_line.clone({stroke:n,points:[e,i,a,o],value:l,column:["d",d].join("_"),strokeWidth:h.pixels_for_leaf}),u.add(s),h.current_draw_values&&(_=h.objects_ref.heatmap_value.clone({x:h._hack_round((e+a)/2-l.length*(h.value_font_size/4)),y:h._hack_round(i-h.value_font_size/2),fontSize:h.value_font_size,text:l}),u.add(_)));e=a}if(h.settings.metadata.draw){var w=h.metadata.nodes[t];if(void 0!==w){var b=Object.keys(h.settings.metadata.colors.value2color).length>0;for(m=0,g=h.on_features.metadata.length;m<g;m++)r=w[d=h.on_features.metadata[m]],a=e+h.pixels_for_dimension,o=i,null!=r&&(l=r,void 0!==h.metadata_descs[d].str2num&&(r=h.metadata_descs[d].str2num[r]),b?void 0===(n=h.settings.metadata.colors.value2color[l])&&(n=h.settings.metadata.colors.default):n=h._get_color_for_value(r,h.metadata_descs[d].min,h.metadata_descs[d].max,h.metadata_descs[d].middle,h.settings.metadata.colors.scale),s=h.objects_ref.heatmap_line.clone({stroke:n,points:[e,i,a,o],value:l,column:["m",d].join("_"),strokeWidth:h.pixels_for_leaf}),u.add(s),h.current_draw_values&&(_=h.objects_ref.heatmap_value.clone({text:l,fontSize:h.value_font_size}),width=_.getWidth(),x=h._hack_round((e+a)/2-width/2),y=h._hack_round(i-h.value_font_size/2),_.position({x:x,y:y}),u.add(_))),e=a}}if(h.settings.count_column.draw&&h.features[h.dimensions.overall-1]){a=e+h.pixels_for_dimension;var k=c.objects.length;n=h._get_color_for_value(k,h.min_item_count,h.max_item_count,h.middle_item_count,h.settings.count_column.colors),s=h.objects_ref.heatmap_line.clone({stroke:n,points:[e,i,a,o],value:k,column:"Count",strokeWidth:h.pixels_for_leaf}),u.add(s),h.current_draw_values&&(_=h.objects_ref.heatmap_value.clone({text:k}),width=_.getWidth(),x=h._hack_round((e+a)/2-width/2),y=h._hack_round(i-h.value_font_size/2),_.position({x:x,y:y}),u.add(_))}return u},e.prototype._draw_column_metadata_row=function(t,e,i,a){for(var o,n,s,r,_,l,d=new Konva.Group({class:"column_metadata"}),h=void 0!==this.column_metadata_descs[e].str2num,c=Object.keys(this.settings.column_metadata.colors.value2color).length>0,u=0,m=this.on_features.data.length;u<m;u++)l=_=t[this.on_features.data[u]],h&&(_=this.column_metadata_descs[e].str2num[_]),c?void 0===(s=this.settings.column_metadata.colors.value2color[l])&&(s=this.settings.column_metadata.colors.default):s=this._get_color_for_value(_,this.column_metadata_descs[e].min,this.column_metadata_descs[e].max,this.column_metadata_descs[e].middle,this.settings.column_metadata.colors.scale),o=i+this.pixels_for_dimension,n=a,r=this.objects_ref.heatmap_line.clone({strokeWidth:this.settings.column_metadata.row_height,stroke:s,value:l,points:[i,a,o,n],column:["cm",e].join("_")}),d.add(r),i=o;if(this.settings.column_metadata.feature_names.draw){var g=this.objects_ref.heatmap_value.clone({x:o+10,y:this._hack_round(n-this.settings.column_metadata.row_height/2),fontSize:this.settings.column_metadata.row_height,text:this.column_metadata.feature_names[e].toString(),fill:"#000000",fontWeight:"bold"});this.heatmap_layer.add(g)}return d},e.prototype._bind_row_events=function(t){var e=this;t.on("mouseenter",function(t){e._row_mouseenter(t)}),t.on("mouseleave",function(t){e._row_mouseleave(t)}),t.on("mouseover",function(t){e._draw_col_label(t)}),t.on("mouseout",function(t){e.heatmap_overlay.find("#col_label")[0].destroy()}),t.on("click",function(t){var a=t.target.parent.attrs.id;if("column_metadata"!==t.target.parent.attrs.class){var o=e.data.nodes[a].objects,n=[];for(i=0;i<o.length;i++)n.push(o[i]);e.events.row_onclick(n,t);var s=e._get_cell_data(t);e.events.cell_click(s,t)}})},e.prototype._draw_row_ids=function(){if(!(this.pixels_for_leaf<6||this.row_id_size<5)){var t,e,i=[];for(t=0,len=this.current_leaf_ids.length;t<len;t++){if(leaf_id=this.current_leaf_ids[t],(e=this.data.nodes[leaf_id].objects).length>1)return;i.push([e[0],this.leaves_y_coordinates[leaf_id]])}var a=this.distance+this._get_visible_count()*this.pixels_for_dimension+15;for(t=0;t<i.length;t++)this.target_element.append($("<div>"+i[t][0].toString()+"</div>").css({position:"absolute",top:this._hack_round(i[t][1]-this.row_id_size/2),left:a,"font-style":"italic","font-size":this.row_id_size,color:"gray"}))}},e.prototype._get_row_id_size=function(){for(var t,e,i=[],a=0,o=this.heatmap_array.length;a<o;a++)e=this.heatmap_array[a][0],(t=this.data.nodes[e].objects).length>1?i.push(t[0]+" +"+(t.length-1)):i=i.concat(t);var n=this._get_max_length(i),s="";for(a=0;a<n;a++)s+="E";if(this.settings.row_ids.fixed_size){var r=new Konva.Text({fontFamily:this.settings.heatmap.font.fontFamily,fontSize:this.settings.row_ids.fixed_size,fontStyle:"italic",listening:!1,text:s,preventDefault:!1});this.row_id_size=this.settings.row_ids.fixed_size,this.right_margin=20+r.width()}else this.row_id_size=this._get_font_size(n,100,this.pixels_for_leaf,10),this.right_margin=100},e.prototype._draw_heatmap_header=function(){var t=this;if(t.settings.heatmap_header.draw&&t.header.length>0){t.header_layer=new Konva.Layer;var e,i,a,o=t.current_leaf_ids.length,n=0,s=[],r=t.settings.heatmap_header.settings;for(i=0,len=t.on_features.data.length;i<len;i++)s.push({label:t.header[t.on_features.data[i]],min:t.data_descs[i].min,max:t.data_descs[i].max});for(i=0,len=t.on_features.metadata.length;i<len;i++){var _=t.on_features.metadata[i]+t.dimensions.data;s.push({label:t.header[_]})}t.settings.count_column.draw&&t.features[t.dimensions.overall-1]&&s.push({label:t.header[t.dimensions.overall-1],min:t.data_descs[t.dimensions.overall-1].min,max:t.data_descs[t.dimensions.overall-1].max});var l=t._get_max_length(s.map(function(t){return t.label}));if(void 0===r.fontSize){var d=t._get_font_size(l,t.header_height,t.pixels_for_dimension,16);if(d<6)return;r.fontSize=d}var h=t.header_height-r.fontSize/2,c=t.pixels_for_dimension/2-r.fontSize/2;for(t.settings.column_dendrogram.draw&&t.heatmap_header&&(h=t.header_height+t.pixels_for_leaf*o+10+t.column_metadata_height,c=r.fontSize/2+t.pixels_for_dimension/2),i=0,len=s.length;i<len;i++)e=t.heatmap_distance+n*t.pixels_for_dimension+c,r.x=e,r.y=h,r.text=s[i].label,r.position_index=i,a=t.objects_ref.column_header.clone(r),t.header_layer.add(a),n++;t.stage.add(t.header_layer),t.settings.dendrogram.draw||(t.header_layer.on("click",function(e){var a=e.target.attrs.position_index;for(i=0;i<t.header_layer.getChildren().length;i++)t.header_layer.getChildren()[i].setFill("black");e.target.setAttrs({fill:"red"}),t._delete_layers([t.heatmap_layer,t.heatmap_overlay,t.highlighted_rows_layer]),t._reorder_heatmap(t._translate_column_to_feature_index(a)),t._draw_heatmap(),t.header_layer.draw()}),t.header_layer.on("mouseover",function(t){t.target.setOpacity(.7),this.draw()}),t.header_layer.on("mouseout",function(t){t.target.setOpacity(1),this.draw()}))}},e.prototype._translate_column_to_feature_index=function(t){for(var e,i=-1,a=0,o=Object.keys(this.features),n=o.length;a<n;a++)if(e=o[a],this.features[e]&&t===++i)return e},e.prototype._draw_distance_scale=function(t){if(this.settings.navigation_toggle.distance_scale){var e=this.header_height+this.column_metadata_height+this.settings.column_metadata.row_height/2-10,i=e,a=this.distance,o=new Konva.Line({points:[0,e,a,i],stroke:"black",listening:!1,preventDefault:!1}),n=new Konva.Circle({x:a,y:i,radius:3,fill:"black",listening:!1,preventDefault:!1}),s=0,r=a,_=this._hack_round(30/this.distance_step*10)/10,l=(t=Math.round(100*this.distance/this.distance_step)/100,this._hack_round(this.distance_step*_)),d=new Konva.Text({x:0,y:e-20,text:t,fontSize:12,fontFamily:this.settings.heatmap.font.fontFamily,fontStyle:"bold",fill:"black",align:"right",listening:!1,preventDefault:!1});if(this.dendrogram_layer.add(o,n,d),0==l&&(l=.5),_>.1)for(;r>0;)o=new Konva.Line({points:[r,e-3,r,i+3],stroke:"black",listening:!1,preventDefault:!1}),this.dendrogram_layer.add(o),(s=this._hack_round(10*(s+_))/10)>10&&(s=this._hack_round(s)),r-=l,0}},e.prototype._draw_navigation=function(){var t=this;t.navigation_layer=new Konva.Layer;var e=0,i=10;if(t.settings.heatmap.draw&&t._draw_color_scale(),t._draw_help(),!t.settings.column_dendrogram.draw&&t.settings.heatmap.draw&&t.settings.navigation_toggle.filter_button){var a=t.objects_ref.icon.clone({data:"M26.834,6.958c0-2.094-4.852-3.791-10.834-3.791c-5.983,0-10.833,1.697-10.833,3.791c0,0.429,0.213,0.84,0.588,1.224l8.662,15.002v4.899c0,0.414,0.709,0.75,1.583,0.75c0.875,0,1.584-0.336,1.584-0.75v-4.816l8.715-15.093h-0.045C26.625,7.792,26.834,7.384,26.834,6.958zM16,9.75c-6.363,0-9.833-1.845-9.833-2.792S9.637,4.167,16,4.167c6.363,0,9.834,1.844,9.834,2.791S22.363,9.75,16,9.75z",x:e,y:i,label:"Filter\ncolumns"}),o=t._draw_icon_overlay(e,i);t.navigation_layer.add(a,o),e+=40,o.on("click",function(){t._filter_icon_click(this)}),o.on("mouseover",function(){t._icon_mouseover(a,o,t.navigation_layer)}),o.on("mouseout",function(){t._icon_mouseout(a,o,t.navigation_layer)})}if(t.zoomed_clusters.row.length>0||t.zoomed_clusters.column.length>0){var n=t.objects_ref.icon.clone({data:"M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z",x:e,y:i,id:"refresh_icon",label:"Refresh"}),s=t._draw_icon_overlay(e,i);t.navigation_layer.add(n,s),s.on("click",function(){t._refresh_icon_click(),t.events.on_refresh()}),s.on("mouseover",function(){t._icon_mouseover(n,s,t.navigation_layer)}),s.on("mouseout",function(){t._icon_mouseout(n,s,t.navigation_layer)})}if(t.zoomed_clusters.row.length>0){e=t.distance-55,i=t.header_height+t.column_metadata_height-40;var r=t.objects_ref.icon.clone({data:t.paths_ref.unzoom_icon,x:e,y:i,scale:{x:.7,y:.7},label:"Unzoom\nrows"}),_=t._draw_icon_overlay(e,i);t.navigation_layer.add(r,_),_.on("click",function(){t._unzoom_icon_click()}),_.on("mouseover",function(){t._icon_mouseover(r,_,t.navigation_layer)}),_.on("mouseout",function(){t._icon_mouseout(r,_,t.navigation_layer)})}if(t.zoomed_clusters.column.length>0){e=t.settings.width-t.right_margin+10,i=t.header_height-50;var l=t.objects_ref.icon.clone({data:t.paths_ref.unzoom_icon,x:e,y:i-5,scale:{x:.7,y:.7},label:"Unzoom\ncolumns"}),d=t._draw_icon_overlay(e,i);t.navigation_layer.add(l,d),d.on("click",function(){t._column_unzoom_icon_click(this)}),d.on("mouseover",function(){t._icon_mouseover(l,d,t.navigation_layer)}),d.on("mouseout",function(){t._icon_mouseout(l,d,t.navigation_layer)})}if(t.settings.navigation_toggle.export_button){var h=t.objects_ref.icon.clone({data:"M24.25,10.25H20.5v-1.5h-9.375v1.5h-3.75c-1.104,0-2,0.896-2,2v10.375c0,1.104,0.896,2,2,2H24.25c1.104,0,2-0.896,2-2V12.25C26.25,11.146,25.354,10.25,24.25,10.25zM15.812,23.499c-3.342,0-6.06-2.719-6.06-6.061c0-3.342,2.718-6.062,6.06-6.062s6.062,2.72,6.062,6.062C21.874,20.78,19.153,23.499,15.812,23.499zM15.812,13.375c-2.244,0-4.062,1.819-4.062,4.062c0,2.244,1.819,4.062,4.062,4.062c2.244,0,4.062-1.818,4.062-4.062C19.875,15.194,18.057,13.375,15.812,13.375z",x:t.settings.width-30,y:10,scale:{x:.7,y:.7},id:"export_icon",label:"Export\nin png format"}),c=t._draw_icon_overlay(t.settings.width-30,10);t.navigation_layer.add(h,c),c.on("click",function(){t._export_icon_click(this)}),c.on("mouseover",function(){t._icon_mouseover(h,c,t.navigation_layer)}),c.on("mouseout",function(){t._icon_mouseout(h,c,t.navigation_layer)})}t.stage.add(t.navigation_layer)},e.prototype._draw_help=function(){var t=this;if(t.settings.navigation_toggle.hint_button){var e=t.objects_ref.icon.clone({data:t.paths_ref.lightbulb,x:t.settings.width-30,y:40,scale:{x:.8,y:.8},id:"help_icon",label:"Tip"}),i=t._draw_icon_overlay(t.settings.width-30,40);t.navigation_layer.add(e,i),i.on("mouseover",function(){t._icon_mouseover(e,i,t.navigation_layer),t._help_mouseover()}),i.on("mouseout",function(){t._help_mouseout(),t._icon_mouseout(e,i,t.navigation_layer)})}},e.prototype._draw_color_scale=function(){var t=this;if(t.settings.navigation_toggle.color_scale){var e=[t.settings.heatmap.colors.params.min/100*.8,t._get_color_for_value(0,0,1,.5,t.settings.heatmap.colors.scale),t.settings.heatmap.colors.params.middle/100*.8,t._get_color_for_value(.5,0,1,.5,t.settings.heatmap.colors.scale),t.settings.heatmap.colors.params.max/100*.8,t._get_color_for_value(1,0,1,.5,t.settings.heatmap.colors.scale)],i=t.objects_ref.rect_gradient.clone({label:"Color settings",fillLinearGradientColorStops:e,id:t.settings.target+"_color_scale"});i.on("mouseover",function(){t._color_scale_mouseover(i,t.navigation_layer)}),i.on("mouseout",function(){t._color_scale_mouseout(i,t.navigation_layer)}),i.on("click",function(){t._color_scale_click(i,t.navigation_layer)}),t.navigation_layer.add(i)}},e.prototype._update_color_scale=function(){this.navigation_layer.find("#"+this.settings.target+"_color_scale").fillLinearGradientColorStops([this.settings.heatmap.colors.params.min/100*.8,this._get_color_for_value(0,0,1,.5,this.settings.heatmap.colors.scale),this.settings.heatmap.colors.params.middle/100*.8,this._get_color_for_value(.5,0,1,.5,this.settings.heatmap.colors.scale),this.settings.heatmap.colors.params.max/100*.8,this._get_color_for_value(1,0,1,.5,this.settings.heatmap.colors.scale)]),this.navigation_layer.draw()},e.prototype._draw_icon_overlay=function(t,e){return this.objects_ref.icon_overlay.clone({x:t,y:e})},e.prototype._highlight_path=function(t,e){var i=this.data.nodes[t];void 0===e&&void 0!==i.color?e=i.color:void 0===e&&void 0===i.color?e="gray":void 0!==e&&void 0!==i.color&&e!==i.color&&(e=i.color),1!=i.count?(this.dendrogram_layer.get("#"+t)[0].stroke(e),this._highlight_path(i.left_child,e),this._highlight_path(i.right_child,e)):(this.highlighted_rows_y.push(this.leaves_y_coordinates[t]),this.current_object_ids.push.apply(this.current_object_ids,i.objects))},e.prototype._highlight_column_path=function(t,e){var i=this.column_dendrogram.nodes[t];1!=i.count?(this.column_dendrogram_layer.get("#col"+t)[0].stroke(e),this._highlight_column_path(i.left_child,e),this._highlight_column_path(i.right_child,e)):this.current_column_ids.push(this.nodes2columns[t])},e.prototype.unhighlight_rows=function(){this.highlight_rows([])},e.prototype.highlight_rows=function(t){var e,i,a,o=this;if(o.settings.heatmap.draw){o.settings.highlighted_rows=t,o.highlighted_rows_layer.destroyChildren();var n=o.settings.heatmap.colors.scale,s=o.settings.metadata.colors.scale;o.settings.heatmap.colors.scale=o.settings.highlight_colors,o.settings.metadata.colors.scale=o.settings.highlight_colors;var r={},_=[];for(e=0;e<t.length;e++)void 0!==o.objects2leaves[t[e]]&&void 0===r[a=o.objects2leaves[t[e]]]&&(_.push(a),r[a]=null);for(e=0;e<_.length;e++)i=o._draw_heatmap_row(_[e],o.heatmap_distance,o.leaves_y_coordinates[_[e]]),o.highlighted_rows_layer.add(i),i.setAttr("listening",!1);o.highlighted_rows_layer.draw(),o.heatmap_overlay.moveToTop(),o.settings.heatmap.colors.scale=n,o.settings.metadata.colors.scale=s,o.highlighted_rows_layer.on("click",function(t){o.heatmap_layer.fire("click")})}},e.prototype._highlight_cluster=function(t){var e=this.last_highlighted_cluster;e&&this.unhighlight_cluster(),e!==t&&(this.last_highlighted_cluster=t,this._highlight_path(t,"#F5273C"),this._draw_cluster_layer(t),this.events.dendrogram_node_highlight(this.current_object_ids,this._unprefix(t))),this.dendrogram_layer.draw()},e.prototype._highlight_column_cluster=function(t){var e=this.last_highlighted_column_cluster;e&&this.unhighlight_column_cluster(),e!==t&&(this.last_highlighted_column_cluster=t,this._highlight_column_path(t,"#F5273C"),this.current_column_ids.sort(function(t,e){return t-e}),this._draw_column_cluster_layer(t),this.events.column_dendrogram_node_highlight(this.current_column_ids,this._unprefix(t))),this.column_dendrogram_layer.draw()},e.prototype.unhighlight_column_cluster=function(){this.last_highlighted_column_cluster&&(this._highlight_column_path(this.last_highlighted_column_cluster,"grey"),this.column_dendrogram_layer.draw(),this.column_cluster_group.destroy(),this.cluster_layer.draw(),this.current_column_ids=[],this.events.column_dendrogram_node_unhighlight(this._unprefix(this.last_highlighted_column_cluster)),this.last_highlighted_column_cluster=null)},e.prototype.highlight_cluster=function(t){return this._highlight_cluster(this._prefix(t))},e.prototype.highlight_column_cluster=function(t){return this._highlight_column_cluster(this._prefix(t))},e.prototype.unhighlight_cluster=function(){this.last_highlighted_cluster&&(this._highlight_path(this.last_highlighted_cluster),this.dendrogram_layer.draw(),this.row_cluster_group.destroy(),this.cluster_layer.draw(),this.events.dendrogram_node_unhighlight(this._unprefix(this.last_highlighted_cluster)),this.highlighted_rows_y=[],this.current_object_ids=[],this.last_highlighted_cluster=null)},e.prototype._neutralize_path=function(t){var e=this.data.nodes[t];if(1!=e.count){var i=this.dendrogram_layer.get("#"+t)[0];i&&(i.setStroke("grey"),this._neutralize_path(e.right_child),this._neutralize_path(e.left_child))}},e.prototype._draw_cluster_layer=function(t){var e=this;e.row_cluster_group=new Konva.Group;var i=e._get_visible_count(),a=e.data.nodes[t].count,o=e.distance-30,n=e.header_height+e.column_metadata_height-40,s=e.objects_ref.count.clone({x:o+10,y:n-10,text:a}),r=e.objects_ref.icon.clone({data:e.paths_ref.zoom_icon,x:o,y:n,scale:{x:.7,y:.7},label:"Zoom\nrows"}),_=e._draw_icon_overlay(o,n);o=e.distance+e.dendrogram_heatmap_distance;var l=i*e.pixels_for_dimension+e.heatmap_distance,d=e.highlighted_rows_y[0]-e.pixels_for_leaf/2,h=e.highlighted_rows_y[e.highlighted_rows_y.length-1]+e.pixels_for_leaf/2,c=e.objects_ref.cluster_overlay.clone({x:o,y:e.header_height+e.column_metadata_height+5,width:l,height:e._hack_round(d-e.header_height-e.column_metadata_height-5)}),u=e.objects_ref.cluster_border.clone({points:[0,d,l,d]}),m=e.objects_ref.cluster_overlay.clone({x:o,y:h,width:l,height:e.settings.height-h-e.footer_height+5}),g=e.objects_ref.cluster_border.clone({points:[0,h,l,h]});e.row_cluster_group.add(s,c,m,r,_,u,g),e.cluster_layer.add(e.row_cluster_group),e.stage.add(e.cluster_layer),s.moveToTop(),e.cluster_layer.draw(),e.cluster_layer.moveToTop(),e.navigation_layer.moveToTop(),_.on("mouseover",function(){e._icon_mouseover(r,_,e.cluster_layer)}),_.on("mouseout",function(){e._icon_mouseout(r,_,e.cluster_layer)}),_.on("click",function(){e._zoom_cluster(e.last_highlighted_cluster)})},e.prototype._draw_column_cluster_layer=function(t){var e=this;e.column_cluster_group=new Konva.Group;var i=e.column_dendrogram.nodes[t].count,a=e.settings.width-e.right_margin+10,o=e.header_height-25,n=e.objects_ref.count.clone({x:a+15,y:o-5,text:i}),s=e.objects_ref.icon.clone({data:e.paths_ref.zoom_icon,x:a,y:o,scale:{x:.7,y:.7},label:"Zoom\ncolumns"}),r=e._draw_icon_overlay(a,o),_=e._hack_round((e.current_column_ids[0]-e.columns_start_index)*e.pixels_for_dimension),l=e._hack_round((e.current_column_ids[0]+e.current_column_ids.length-e.columns_start_index)*e.pixels_for_dimension),d=e.settings.height-e.footer_height-e.header_height+e.settings.column_metadata.row_height+e.column_metadata_height,h=d+e.header_height,c=e.objects_ref.cluster_border.clone({points:[e.heatmap_distance+_,0,e.heatmap_distance+_,h]}),u=e.objects_ref.cluster_overlay.clone({x:e.heatmap_distance,y:e.header_height,width:_,height:d}),m=e.objects_ref.cluster_border.clone({points:[e.heatmap_distance+l,0,e.heatmap_distance+l,h]}),g=e.objects_ref.cluster_overlay.clone({x:l+e.heatmap_distance,y:e.header_height,width:e.heatmap_width-l-(e.on_features.metadata.length+e.on_features.count_column.length)*e.pixels_for_dimension,height:d});e.column_cluster_group.add(u,g,s,r,n,c,m),e.cluster_layer.add(e.column_cluster_group),e.stage.add(e.cluster_layer),e.cluster_layer.draw(),e.cluster_layer.moveToTop(),e.navigation_layer.moveToTop(),r.on("mouseover",function(){e._icon_mouseover(s,r,e.cluster_layer)}),r.on("mouseout",function(){e._icon_mouseout(s,r,e.cluster_layer)}),r.on("click",function(){e._zoom_column_cluster(e.last_highlighted_column_cluster)})},e.prototype._draw_column_cluster=function(t){this.columns_start_index=this.current_column_ids[0],this.on_features.data=this.current_column_ids;var e=this.distance;if(this._adjust_horizontal_sizes(),this._delete_layers([this.column_dendrogram_layer,this.heatmap_layer,this.heatmap_overlay,this.column_cluster_group,this.navigation_layer,this.highlighted_rows_layer],[this.dendrogram_hover_layer]),this.settings.heatmap_header.draw&&this._delete_layers([this.header_layer]),this._draw_column_dendrogram(t),this._draw_heatmap(),this._draw_heatmap_header(),this._draw_navigation(),this.settings.dendrogram.draw)if(e!==this.distance){this._delete_layers([this.dendrogram_layer,this.cluster_layer]);var i=this.zoomed_clusters.row.length>0?this.zoomed_clusters.row[this.zoomed_clusters.row.length-1]:this.root_id;this._draw_row_dendrogram(i),null!==this.last_highlighted_cluster&&(this._highlight_path(this.last_highlighted_cluster,"#F5273C"),this.dendrogram_layer.draw(),this._draw_cluster_layer(this.last_highlighted_cluster))}else this.cluster_layer.moveToTop(),this.cluster_layer.draw()},e.prototype._zoom_column_cluster=function(t){t!=this.column_root_id&&(this.zoomed_clusters.column.push(t),this._draw_column_cluster(t),this.highlight_rows(this.settings.highlighted_rows),this.events.on_columns_zoom(this.current_column_ids,this._unprefix(t)),this.current_column_ids=[],this.last_highlighted_column_cluster=null)},e.prototype._unzoom_column_cluster=function(){var t=this.zoomed_clusters.column.pop(),e=this.zoomed_clusters.column.length,i=e>0?this.zoomed_clusters.column[e-1]:this.column_root_id;this._get_column_ids(i),this._draw_column_cluster(i),this.events.on_columns_unzoom(this._unprefix(t)),this.current_column_ids=[],this._highlight_column_cluster(t)},e.prototype._draw_cluster=function(t){this._delete_layers([this.dendrogram_layer,this.heatmap_layer,this.heatmap_overlay,this.cluster_layer,this.navigation_layer,this.header_layer,this.highlighted_rows_layer],[this.dendrogram_hover_layer]),this._draw_row_dendrogram(t),this._get_row_id_size(),this._draw_heatmap(),this._draw_heatmap_header(),this._draw_navigation(),this.settings.column_dendrogram.draw&&null!==this.last_highlighted_column_cluster&&this._draw_column_cluster_layer(this.last_highlighted_column_cluster)},e.prototype._zoom_cluster=function(t){t!==this.root_id&&(this.zoomed_clusters.row.push(t),this._draw_cluster(t),this.highlight_rows(this.settings.highlighted_rows),this.events.on_zoom(this.current_object_ids,this._unprefix(t)),this.highlighted_rows_y=[],this.current_object_ids=[],this.last_highlighted_cluster=null)},e.prototype._unzoom_cluster=function(){var t=this.zoomed_clusters.row.pop(),e=this.zoomed_clusters.row.length,i=e>0?this.zoomed_clusters.row[e-1]:this.root_id;this._draw_cluster(i),this.events.on_unzoom(this._unprefix(t)),this._highlight_cluster(t)},e.prototype._get_node_neighbourhood=function(t,e){var i={left_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},right_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},left_count:e[t.left_child].count,right_count:e[t.right_child].count},a=e[t.left_child],o=e[t.right_child],n=e[a.left_child],s=e[a.right_child],r=e[o.left_child],_=e[o.right_child];return 1!=a.count&&(i.left_node.left_count=e[a.left_child].count,i.left_node.right_count=e[a.right_child].count,1!=n.count?(i.left_node.left_node.left_count=e[n.left_child].count,i.left_node.left_node.right_count=e[n.right_child].count):(i.left_node.left_node.left_count=.5,i.left_node.left_node.right_count=.5),1!=s.count?(i.left_node.right_node.left_count=e[s.left_child].count,i.left_node.right_node.right_count=e[s.right_child].count):(i.left_node.right_node.left_count=.5,i.left_node.right_node.right_count=.5)),1!=o.count&&(i.right_node.left_count=e[o.left_child].count,i.right_node.right_count=e[o.right_child].count,1!=r.count?(i.right_node.left_node.left_count=e[r.left_child].count,i.right_node.left_node.right_count=e[r.right_child].count):(i.right_node.left_node.left_count=.5,i.right_node.left_node.right_count=.5),1!=_.count?(i.right_node.right_node.left_count=e[_.left_child].count,i.right_node.right_node.right_count=e[_.right_child].count):(i.right_node.right_node.left_count=.5,i.right_node.right_node.right_count=.5)),i},e.prototype._draw_column_dendrogram_node=function(t,e,i,a,o,n){if(e.count>1){var s=this._get_node_neighbourhood(e,this.column_dendrogram.nodes),r=this.column_dendrogram.nodes[e.right_child],_=this.column_dendrogram.nodes[e.left_child],l=this._get_x1(s,i,a),d=this._get_x2(s,i,a),h=this._hack_round(this.vertical_distance-this.vertical_distance_step*e.distance),c=h=0==h?2:h;1==r.count&&(d-=this.pixels_for_dimension/2);var u=this.vertical_distance-this.vertical_distance_step*this.column_dendrogram.nodes[e.left_child].distance,m=this.vertical_distance-this.vertical_distance_step*this.column_dendrogram.nodes[e.right_child].distance;this.column_dendrogram_layer.add(this._draw_vertical_path(t,l,h,d,c,u,m)),this._draw_column_dendrogram_node(e.left_child,_,i-s.left_node.right_count,a+s.left_node.right_count,u,h),this._draw_column_dendrogram_node(e.right_child,r,i+s.right_node.left_count,a-s.right_node.left_count,m,c)}else this.column_x_coordinates[t]=a*this.pixels_for_dimension},e.prototype._get_y1=function(t,e,i){return((e=e-t.left_node.right_count-t.left_node.left_node.right_count)+(t.left_node.left_node.right_count+t.left_node.right_node.left_count)/2)*this.pixels_for_leaf+this.top_heatmap_distance},e.prototype._get_y2=function(t,e,i){return((e+=t.right_node.left_node.left_count)+(t.right_node.left_node.right_count+t.right_node.right_node.left_count)/2)*this.pixels_for_leaf+this.top_heatmap_distance},e.prototype._get_x1=function(t,e,i){var a=((e=e-t.left_node.right_count-t.left_node.left_node.right_count)+(t.left_node.left_node.right_count+t.left_node.right_node.left_count)/2)*this.pixels_for_dimension;return this.heatmap_distance+this.on_features.data.length*this.pixels_for_dimension-a},e.prototype._get_x2=function(t,e,i){var a=((e+=t.right_node.left_node.left_count)+(t.right_node.left_node.right_count+t.right_node.right_node.left_count)/2)*this.pixels_for_dimension;return this.heatmap_distance+this.on_features.data.length*this.pixels_for_dimension-a},e.prototype._draw_vertical_path=function(t,e,i,a,o,n,s){var r=new Konva.Group({}),_=this.objects_ref.node.clone({points:[e,n,e,i,a,o,a,s],id:"col"+t}),l=this.objects_ref.node_rect.clone({x:a-1,y:i-1,width:e-a+2,height:this.header_height-i,id:"col_rect"+t,path:_,path_id:t});return r.add(_,l),r},e.prototype._draw_horizontal_path=function(t,e,i,a,o,n,s,r){void 0===r&&(r="gray");var _=new Konva.Group({}),l=this.objects_ref.node.clone({points:[n,i,e,i,a,o,s,o],id:t,stroke:r}),d=this.objects_ref.node_rect.clone({x:e-1,y:i-1,width:this.distance-e,height:o-i,id:[t,"rect"].join("_"),path:l,path_id:t});return _.add(l,d),_},e.prototype._filter_icon_click=function(t){var e=this,i=e.target_element.find(".filter_features"),a="";if(i.length){i.fadeIn("fast");var o=e._draw_target_overlay()}else{for(var n in filter_list="",e.header)if(e.features[n]&&(a=""),n<e.dimensions){var s=e.header[n];""==s&&(s=parseInt(n)+1+". column"),filter_list=filter_list+"<li class='feature_switch' data-num='"+n+"'><span class='symbol'>"+a+"</span>  "+s+"</li>"}e.target_element.append("<div class='filter_features'><ul>"+filter_list+"</ul><hr /><div><span class='cancel_filter_list'>Cancel</span>&nbsp;&nbsp;&nbsp;<span class='update_filter_list'>Update</span></div></div>"),(i=e.target_element.find(".filter_features")).css({display:"none",top:45,left:0,"border-radius":"5px","text-align":"center",position:"absolute","background-color":"#ffffff",border:"solid 2px #DEDEDE","padding-top":"5px","padding-left":"15px","padding-bottom":"10px","padding-right":"15px","font-weight":"bold","font-size":"14px","z-index":1e3,"font-family":e.settings.heatmap.font.fontFamily}),i.find("ul").css({"list-style-type":"none","margin-left":"0","padding-left":"0","text-align":"left"}),i.find("li").css({color:"green","margin-top":"5px"}),i.find("div").css({cursor:"pointer",opacity:"0.7"});o=e._draw_target_overlay();i.fadeIn("fast"),e.target_element.find(".feature_switch").click(function(){var t=parseInt($(this).attr("data-num")),i=$(this).find("span");e.features[t]=!e.features[t],e.features[t]?(i.text(""),$(this).css("color","green")):(i.text(""),$(this).css("color","red")),e._set_on_features()}),$(function(){i.click(function(){return!1}),i.mousedown(function(){return!1}),$("#"+e.settings.target+" .filter_features ul li,#"+e.settings.target+" .filter_features div span").hover(function(){$(this).css({cursor:"pointer",opacity:"0.7"})},function(){$(this).css({cursor:"default",opacity:"1"})})}),e.target_element.find(".cancel_filter_list").click(function(){i.fadeOut("fast"),o.fadeOut("fast")}),o.click(function(){i.fadeOut("fast"),o.fadeOut("fast")}),e.target_element.find(".update_filter_list").click(function(){i.fadeOut("slow"),o.fadeOut("slow");var t=e.zoomed_clusters.row.length>0?e.zoomed_clusters.row[e.zoomed_clusters.row.length-1]:e.root_id,a=e.last_highlighted_cluster;e.last_highlighted_cluster=null,e._adjust_horizontal_sizes(),e._delete_all_layers(),e._draw_stage_layer(),e.settings.dendrogram.draw&&(e._draw_dendrogram_layers(),e._draw_row_dendrogram(t),e._draw_dendrogram_layers(),e.settings.column_dendrogram.draw&&e._visible_features_equal_column_dendrogram_count()&&e._draw_column_dendrogram(e.column_root_id)),e._draw_navigation(),e._draw_heatmap(),e._draw_heatmap_header(),null!=a&&e._highlight_cluster(a)})}},e.prototype._draw_target_overlay=function(){var t=this.target_element.find(".target_overlay");return t.length?t.fadeIn("fast"):((t=$("<div class='target_overlay'></div>")).css({"background-color":"white",position:"absolute",top:0,left:0,right:0,bottom:0,opacity:.5}),this.target_element.append(t)),t},e.prototype._refresh_icon_click=function(){this.redraw()},e.prototype._export_icon_click=function(){html2canvas(this.target_element[0],{backgroundColor:null,scale:2}).then(function(t){var e=document.createElement("a");e.href=t.toDataURL("image/png").replace("image/png","image/octet-stream"),e.download="inchlib.png",e.click()})},e.prototype._color_scale_click=function(t,e){var i,a,o,n,s=this,r={heatmap:"Heatmap data colors"},_=["min","middle","max"];s.settings.metadata.draw&&(r.metadata="Metadata colors"),s.settings.column_metadata.draw&&(r.column_metadata="Column metadata colors");var l=s.target_element.find(".inchlib-settings_form"),d=s._draw_target_overlay();if(l.length)l.fadeIn("fast");else{l=$("<form class='inchlib-settings_form'></form>");var h,c,u;for(i=0,keys=Object.keys(r),len=keys.length;i<len;i++){o=keys[i];var m=$("<div class='inchlib-section' data-name='"+o+"' ></div>").css({"margin-bottom":5,"padding-bottom":5,"border-bottom":"solid #D2D2D2 1px"});h=s._get_color_for_value(0,0,1,.5,s.settings[o].colors.scale),c=s._get_color_for_value(.5,0,1,.5,s.settings[o].colors.scale),u=s._get_color_for_value(1,0,1,.5,s.settings[o].colors.scale),m.append($("<div class='form_label'>"+r[o]+"</div>")),m.append($("<div><input class='inchlib-color_input' type='text' name='colors.scale' value='"+s.settings[o].colors.scale+"'/> <div class='color_button' style='background: linear-gradient(to right, "+h+","+c+","+u+")'></div></div>").css({display:"flex","align-items":"center"}));var g=$("<div class='inchlib-params'></div>").css({display:"flex","justify-content":"space-between"});for(i2=0,len2=_.length;i2<len2;i2++)key2=_[i2],g.append($("<div><div class='form_label'>"+key2+"</div><input type='text' name='colors.params."+key2+"' value='"+s.settings[o].colors.params[key2]+"'/></div>"));m.append(g),m.append($("<div><div class='form_label'>Value type</div>                  <select name='value_type'>                    <option value='percentile' selected>Percentile</option>                    <option value='value'>Value</option>                  </select></div>                  <div><div class='form_label'>Color by</div>                  <select name='independent_columns'>                    <option value='true' selected>By columns</option>                    <option value='false'>Entire heatmap</option>                  </select></div>")),l.append(m)}l.append($("<button type='submit'>Redraw</button>")),s.target_element.append(l),l.css({width:150,"z-index":1e3,position:"absolute",top:110,left:0,padding:"10px",border:"solid #D2D2D2 2px","border-radius":"5px","background-color":"white","font-size":"small"}),s.target_element.find(".inchlib-settings_form .color_button").css({border:"solid #D2D2D2 1px",height:"15px",width:"30px",display:"inline-block"}),s.target_element.find(".inchlib-settings_form input[type='text']").css({width:40}),s.target_element.find(".inchlib-settings_form .inchlib-color_input").css({width:80,"margin-right":3}),s.target_element.find(".inchlib-settings_form .inchlib-section > *").css({"margin-bottom":5}),s.target_element.find(".inchlib-settings_form .form_label").css({color:"gray","margin-bottom":5,"font-style":"italic"}),s.target_element.find(".inchlib-settings_form button").css({padding:5,color:"white",border:"none",width:"100%","background-color":"#2171b5","font-weight":"bold"}),d.click(function(){l.fadeOut("fast"),d.fadeOut("fast")});var p=l.find(".color_button");p.hover(function(){$(this).css({cursor:"pointer",opacity:.7})},function(){$(this).css({opacity:1})}),p.click(function(t){s._draw_color_scales_select(this,t)}),l.submit(function(t){var e=$(this).find("input, select");t.preventDefault(),t.stopPropagation(),e.each(function(){var t=$(this).parents(".inchlib-section").attr("data-name");a=$(this);var e=(o=a.attr("name")).split(".");n=a.val(),-1!==_.indexOf(e[e.length-1])&&(n=parseFloat(n)),1==e.length?s.settings[t][e[0]]=n:2==e.length?s.settings[t][e[0]][e[1]]=n:s.settings[t][e[0]][e[1]][e[2]]=n}),s.redraw_heatmap(),s._update_color_scale(),d.trigger("click")})}},e.prototype._draw_color_scales_select=function(t,e){var i,a=this,o=a.target_element.find(".color_scales");if(o.length)o.fadeIn("fast"),i=o.find(".color_scale");else{var n,s;o=$("<div class='color_scales'></div>").css({"z-index":10});for(var r=0,_=Object.keys(a.colors),l=_.length;r<l;r++)n="<div class='color_scale' data-scale_acronym='"+(s=_[r])+"' style='background: linear-gradient(to right, "+a._get_color_for_value(0,0,1,.5,s)+","+a._get_color_for_value(.5,0,1,.5,s)+","+a._get_color_for_value(1,0,1,.5,s)+")'></div>",o.append(n);a.target_element.append(o),o.css({border:"solid #D2D2D2 2px","border-radius":"5px",padding:"5px",position:"absolute",top:110,left:170,"background-color":"white"}),(i=a.target_element.find(".color_scale")).css({"margin-top":"3px",width:"80px",height:"20px",border:"solid #D2D2D2 1px"}),i.hover(function(){$(this).css({cursor:"pointer",opacity:.7})},function(){$(this).css({opacity:1})}),a.target_element.find(".target_overlay").click(function(){o.fadeOut("fast")})}i.on("click",function(){var e=$(this).attr("data-scale_acronym");$(t).prev("input:first").val(e);$(t).css({background:"linear-gradient(to right, "+a._get_color_for_value(0,0,1,.5,e)+","+a._get_color_for_value(.5,0,1,.5,e)+","+a._get_color_for_value(1,0,1,.5,e)+")"}),o.fadeOut("fast"),i.off("click")})},e.prototype._color_scale_mouseover=function(t,e){var i=t.getAttr("label"),a=t.getAttr("x"),o=t.getAttr("y");this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:a,y:o+25}),this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone()),this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:i})),e.add(this.icon_tooltip),this.icon_tooltip.moveToTop(),t.setOpacity(.7),e.draw()},e.prototype._color_scale_mouseout=function(t,e){this.icon_tooltip.destroy(),t.setOpacity(1),e.draw()},e.prototype._unzoom_icon_click=function(){this._unzoom_cluster()},e.prototype._column_unzoom_icon_click=function(){this._unzoom_column_cluster()},e.prototype._icon_mouseover=function(t,e,i){if("help_icon"!==t.getAttr("id")){var a=t.getAttr("label"),o=e.getAttr("x"),n=e.getAttr("y"),s=(e.getWidth(),e.getHeight());"export_icon"===t.getAttr("id")&&(o-=100,n-=50),this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:o,y:n+1.2*s}),this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone()),this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:a})),i.add(this.icon_tooltip)}t.setFill("black"),i.draw()},e.prototype._icon_mouseout=function(t,e,i){"help_icon"!==t.getAttr("id")&&this.icon_tooltip.destroy(),t.setFill("grey"),i.draw()},e.prototype._help_mouseover=function(){var t=this.target_element.find(".inchlib_help");t.length?t.show():((t=$("<div class='inchlib_help'><ul><li>Zoom clusters by a long click on a dendrogram node.</li></ul></div>")).css({position:"absolute",top:70,left:this.settings.width-200,"font-size":12,"padding-right":15,width:200,"background-color":"white","border-radius":5,border:"solid #DEDEDE 2px","z-index":1e3}),this.target_element.append(t))},e.prototype._help_mouseout=function(){this.target_element.find(".inchlib_help").hide()},e.prototype._dendrogram_layers_click=function(t,e){var i=e.target.attrs.path_id;t.fire("mouseout",t,e),this._highlight_cluster(i),this.events.dendrogram_node_onclick(this.current_object_ids,this._unprefix(i),e)},e.prototype._column_dendrogram_layers_click=function(t,e){var i=e.target.attrs.path_id;t.fire("mouseout",t,e),this._highlight_column_cluster(i),this.events.column_dendrogram_node_onclick(this.current_column_ids,this._unprefix(i),e)},e.prototype._dendrogram_layers_mousedown=function(t,e){var i=this,a=e.target.attrs.path_id;clearTimeout(i.timer),i.timer=setTimeout(function(){i._get_object_ids(a),i._zoom_cluster(a)},500)},e.prototype._column_dendrogram_layers_mousedown=function(t,e){var i=this,a=e.target.attrs.path_id;clearTimeout(i.timer),i.timer=setTimeout(function(){i._get_column_ids(a),i._zoom_column_cluster(a)},500)},e.prototype._dendrogram_layers_mouseup=function(t,e){clearTimeout(this.timer)},e.prototype._dendrogram_layers_mouseout=function(t,e){void 0!==this.path_overlay&&this.path_overlay.destroy(),this.dendrogram_hover_layer.draw()},e.prototype._dendrogram_layers_mouseover=function(t,e){this.path_overlay=e.target.attrs.path.clone({strokeWidth:4}),this.dendrogram_hover_layer.add(this.path_overlay),this.dendrogram_hover_layer.draw()},e.prototype._visible_features_equal_column_dendrogram_count=function(){return this.on_features.data.length+this.on_features.metadata.length==this.current_column_count},e.prototype._get_color_for_value=function(t,e,i,a,o){var n=this.colors[o],s=n.start,r=n.end;if(t>i)return"rgb("+r.r+","+r.g+","+r.b+")";if(e==i||t<e)return"rgb("+s.r+","+s.g+","+s.b+")";if(void 0!==n.middle)if(t>=a){if(a==i)return"rgb("+r.r+","+r.g+","+r.b+")";e=a,s=n.middle,r=n.end}else{if(a==e)return"rgb("+s.r+","+s.g+","+s.b+")";i=a,s=n.start,r=n.middle}var _=(t-e)/(i-e);return"rgb("+this._hack_round(s.r+_*(r.r-s.r))+","+this._hack_round(s.g+_*(r.g-s.g))+","+this._hack_round(s.b+_*(r.b-s.b))+")"},e.prototype._get_font_size=function(t,e,i,a){var o=i-2,n=o;return n/2*t>e-10&&(n/=n/2*t/(e-10)),n=(n=n>o?o:n)>a?a:n},e.prototype._get_object_ids=function(t){this.current_object_ids=[],this._collect_object_ids(t)},e.prototype._collect_object_ids=function(t){void 0!==this.data.nodes[t].left_child?(this._collect_object_ids(this.data.nodes[t].left_child),this._collect_object_ids(this.data.nodes[t].right_child)):this.current_object_ids.push.apply(this.current_object_ids,this.data.nodes[t].objects)},e.prototype._get_column_ids=function(t){this.current_column_ids=[],this._collect_column_ids(t),this.current_column_ids.sort(function(t,e){return t-e})},e.prototype._collect_column_ids=function(t){void 0!==this.column_dendrogram.nodes[t].left_child?(this._collect_column_ids(this.column_dendrogram.nodes[t].left_child),this._collect_column_ids(this.column_dendrogram.nodes[t].right_child)):this.current_column_ids.push(this.nodes2columns[t])},e.prototype._hack_size=function(t){return Object.keys(t).length},e.prototype._hack_round=function(t){return.5+t>>0},e.prototype._is_number=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},e.prototype._row_mouseenter=function(t){var e=t.target.parent.getAttr("id");this._get_visible_count();if("column_metadata"!==t.target.parent.attrs.class){this.highlighted_row=e;var i=this.leaves_y_coordinates[e],a=this.heatmap_distance;this.row_overlay=this.objects_ref.heatmap_line.clone({points:[a,i,a+this.heatmap_width,i],strokeWidth:this.pixels_for_leaf,stroke:"#FFFFFF",opacity:.3,listening:!1}),this.heatmap_overlay.add(this.row_overlay),this.heatmap_overlay.draw(),this.events.row_onmouseover(this.data.nodes[e].objects,t)}},e.prototype._row_mouseleave=function(t){this.row_overlay.destroy(),this.events.row_onmouseout(t)},e.prototype._get_cell_data=function(t){var e=t.target.attrs,i=e.column.split("_"),a={d:this.heatmap_header[i[1]],m:this.metadata_header[i[1]],Count:"Count"};return void 0!==this.column_metadata_header&&(a.cm=this.column_metadata_header[i[1]]),{value:e.value,header:a[i[0]]}},e.prototype._draw_col_label=function(t){var e=t.target.parent,i=t.target.attrs,a=i.points,o=this._hack_round((a[0]+a[2])/2),n=a[1]-.5*this.pixels_for_leaf,s=i.column.split("_"),r={d:this.heatmap_header[s[1]],m:this.metadata_header[s[1]],Count:"Count"};void 0!==this.column_metadata_header&&(r.cm=this.column_metadata_header[s[1]]);var _=r[s[0]];_!==this.last_column&&(this.column_overlay.destroy(),this.last_column=i.column,this.column_overlay=this.objects_ref.heatmap_line.clone({points:[o,this.header_height,o,this.header_height+this.column_metadata_height+(this.heatmap_array.length+.5)*this.pixels_for_leaf],strokeWidth:this.pixels_for_dimension,stroke:"#FFFFFF",opacity:.3,listening:!1}),this.heatmap_overlay.add(this.column_overlay)),this.events.cell_mouseover({value:d,header:_},t);var l=[];this.settings.row_ids.tooltip&&"column_metadata"!==e.getAttr("class")&&l.push(this.data.nodes[e.getAttr("id")].objects.join(", ")),void 0!==_&&l.push(_),l.push(i.value);var d=l.join("\n"),h=this.objects_ref.tooltip_label.clone({x:o,y:n,id:"col_label"});h.add(this.objects_ref.tooltip_tag.clone({pointerDirection:"down"}),this.objects_ref.tooltip_text.clone({text:d})),this.heatmap_overlay.add(h),this.heatmap_overlay.moveToTop(),this.heatmap_overlay.draw()},e.prototype._unprefix=function(t){return t.split(this.settings.target+"#")[1]},e.prototype._prefix=function(t){return this.settings.target+"#"+t},e.prototype.get_features_for_object=function(t){if(void 0!==this.objects2leaves[t]){var e=this.objects2leaves[t];return this.data.nodes[e].features}return!1},e.prototype.add_color_scale=function(t,e){this.colors[t]=e,this.target_element.find(".color_scales").remove()},e.prototype._get_visible_count=function(){return this.on_features.data.length+this.on_features.metadata.length+this.on_features.count_column.length},e.prototype.update_settings=function(t){this.settings.navigation_toggle;this.settings=h(this.settings,t),this.dynamic_width=!1,"dynamic"===this.settings.width&&(this.dynamic_width=!0,0===this.target_element.width()&&this.target_element.css({width:"100%"}),this.settings.width=this.target_element.width())},e.prototype.redraw=function(){this.dynamic_width&&(this.settings.width=this.target_element.width()),this._delete_all_layers(),this.draw()},e.prototype.redraw_heatmap=function(){this._delete_layers([this.heatmap_layer,this.heatmap_overlay,this.highlighted_rows_layer,this.header_layer]),this._set_color_settings(),this._draw_heatmap(),this._draw_heatmap_header(),this.heatmap_layer.moveToBottom(),this.heatmap_layer.moveUp()},e.prototype.add_metadata_column=function(t,e){null==this.metadata?this.metadata={feature_names:[t],nodes:{}}:this.metadata.feature_names.push(t);for(var i=0,a=this.point_ids.length;i<a;i++){var o=this.point_ids[i];if(void 0!==this.data.nodes[o].objects){var n=e[this.data.nodes[o].objects[0]];void 0===n&&(n=null),void 0===this.metadata.nodes[o]?this.metadata.nodes[o]=[n]:this.metadata.nodes[o].push(n)}}},require("biojs-events").mixin(e.prototype),module.exports=e;
},{"../components/insertable":"k0lz","biojs-events":"iPX1"}]},{},["dVJU"], null)
//# sourceMappingURL=heatmap_client/inchlib-1.2.0.99bfc1ac.js.map